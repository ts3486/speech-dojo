"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[614],{5614:(e,t,s)=>{s.r(t),s.d(t,{default:()=>M});var n=s(3798),i=s(3651),r=s(6091),a=s(1462),o=s(7263);async function l(e,t,s,n){var i;let r=await fetch("".concat(e,"/api/realtime/session"),{method:"POST",headers:{"Content-Type":"application/json",...s?{"x-user-id":s}:{}},body:JSON.stringify({session_id:t,force_refresh:null!=(i=null==n?void 0:n.forceRefresh)&&i,...(null==n?void 0:n.status)?{status:n.status}:{}})});if(!r.ok)throw Error("Failed to fetch client secret");return r.json()}async function c(){try{return(await navigator.mediaDevices.getUserMedia({audio:!0})).getTracks().forEach(e=>e.stop()),"granted"}catch(e){if(e instanceof DOMException&&"NotAllowedError"===e.name)return"denied";return"error"}}class d{async start(e){this.chunks=[],this.startTime=performance.now(),this.mediaRecorder=new MediaRecorder(e),this.mediaRecorder.ondataavailable=e=>{e.data.size>0&&this.chunks.push(e.data)},this.mediaRecorder.start()}async stop(){if(!this.mediaRecorder)throw Error("Recorder not started");let e=new Promise(e=>{this.mediaRecorder.onstop=()=>e()});return this.mediaRecorder.stop(),await e,{blob:new Blob(this.chunks,{type:"audio/webm"}),durationMs:performance.now()-(this.startTime||performance.now())|0}}constructor(){this.chunks=[]}}function u(e){let{segments:t}=e;return t.length?(0,n.jsx)("ul",{className:"transcript-list","aria-label":"transcript",children:t.map((e,t)=>(0,n.jsxs)("li",{children:[(0,n.jsxs)("span",{className:"pill",children:[(0,n.jsx)("span",{className:"pill-dot"}),e.speaker,e.timestamp?" • ".concat(e.timestamp):""]}),(0,n.jsx)("div",{children:e.text})]},t))}):(0,n.jsx)("p",{children:"No transcript yet."})}let h={network:{bg:"bg-[#fff7ed]",border:"border-primary"},mic:{bg:"bg-[#fff7ed]",border:"border-primary"},token:{bg:"bg-[#fff7ed]",border:"border-primary"},info:{bg:"bg-[#f0f6ff]",border:"border-[#5b8def]"},error:{bg:"bg-[#fff0ed]",border:"border-danger"}};function p(e){let{alerts:t}=e;return t.length?(0,n.jsx)("div",{"aria-label":"alerts",className:"alert-stack",children:t.map(e=>{let t=h[e.tone]||h.info;return(0,n.jsxs)("div",{role:"alert",className:"alert-card ".concat(t.bg," ").concat(t.border),children:[(0,n.jsx)("p",{className:"alert-card__title",children:e.message}),e.actions&&e.actions.length>0&&(0,n.jsx)("div",{className:"alert-card__actions",children:e.actions.map((e,s)=>(0,n.jsx)("button",{type:"button",onClick:e.onClick,className:"border rounded-[12px] px-2.5 py-2 text-sm ".concat(t.border),children:e.label},s))})]},e.id)})}):null}function m(e){let{label:t,tone:s="idle"}=e,i={active:{bg:"bg-secondary/15",dot:"bg-secondary",text:"text-secondary"},recovering:{bg:"bg-primary/20",dot:"bg-primary",text:"text-primary"},error:{bg:"bg-danger/15",dot:"bg-danger",text:"text-danger"},idle:{bg:"bg-black/5",dot:"bg-muted",text:"text-muted"}}[null!=s?s:"idle"];return(0,n.jsxs)("span",{className:"inline-flex items-center gap-2 px-2.5 py-1 rounded-full text-xs font-semibold ".concat(i.bg," ").concat(i.text),"aria-label":"Status: ".concat(t),children:[(0,n.jsx)("span",{className:"w-2 h-2 rounded-full inline-block ".concat(i.dot)}),t]})}function x(e){let{status:t}=e;return(0,n.jsxs)("div",{"aria-label":"session status",className:"flex items-center gap-3 px-3 py-2 border border-border rounded-[12px] bg-surface shadow-soft",children:[(0,n.jsx)(m,{label:"Connection: ".concat(t.connection),tone:"active"===t.connection?"active":"recovering"===t.connection?"recovering":"error"===t.connection?"error":"idle"}),(0,n.jsx)(m,{label:"Mic: ".concat(t.mic),tone:"granted"===t.mic?"active":"denied"===t.mic||"error"===t.mic?"error":"idle"}),(0,n.jsx)(m,{label:"Token: ".concat(t.token),tone:"valid"===t.token?"active":"refreshing"===t.token?"recovering":"error"===t.token?"error":"idle"}),t.info&&(0,n.jsx)("span",{className:"text-sm text-muted",children:t.info})]})}let g={primary:"bg-primary text-white border border-primary hover:bg-primaryHover hover:-translate-y-[1px]",secondary:"bg-white text-text border border-border hover:bg-black/5 hover:-translate-y-[1px]",danger:"bg-danger text-white border border-danger hover:bg-[#d23b3b] hover:-translate-y-[1px]",ghost:"bg-transparent text-text border border-transparent hover:bg-black/5 hover:-translate-y-[1px]"},f="inline-flex items-center gap-2 rounded-[12px] px-4 py-2 font-semibold transition duration-150 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-secondary/60 disabled:opacity-60 disabled:cursor-not-allowed";function j(e){let{children:t,variant:s="primary",disabled:i,className:r,onClick:a,type:o="button"}=e;return(0,n.jsx)("button",{type:o,onClick:a,disabled:i,className:"".concat(f," ").concat(g[s]," ").concat(null!=r?r:"").trim(),children:t})}function b(e){let{children:t,to:s,variant:i="secondary",disabled:a,className:o}=e;return(0,n.jsx)(r.N_,{to:a?"#":s,"aria-disabled":a,className:"".concat(f," ").concat(g[i]," ").concat(null!=o?o:"").trim(),children:t})}let y="http://localhost:8000",v="00000000-0000-0000-0000-000000000001";async function w(){var e;let t=await fetch("".concat(y,"/api/topics"),{headers:{"x-user-id":v}});if(!t.ok)throw Error("Failed to load topics");return null!=(e=await t.json())?e:[]}async function N(){let e=await fetch("".concat(y,"/api/sessions"),{headers:{"x-user-id":v}});if(!e.ok)throw Error("Failed to fetch history");let t=await e.json();return t.sessions||t||[]}async function k(e){let t=await fetch("".concat(y,"/api/sessions/").concat(e),{headers:{"x-user-id":v}});if(!t.ok)throw Error("Failed to load session");let s=await t.json();return s.session||s}function S(){let[e]=(0,r.ok)(),[t,s]=(0,a.useState)(),[i,h]=(0,a.useState)(null),[m,g]=(0,a.useState)("idle"),[f,b]=(0,a.useState)([]),[N,k]=(0,a.useState)(null),[S,_]=(0,a.useState)([]),[E,C]=(0,a.useState)(null),[R,T]=(0,a.useState)(!1),[F,L]=(0,a.useState)([]),[M,D]=(0,a.useState)(!navigator.onLine),[q,O]=(0,a.useState)("idle"),[U,z]=(0,a.useState)("idle"),I=(0,a.useRef)(null),P=(0,a.useRef)(null),{data:H=[],error:A}=(0,o.I)({queryKey:["topics"],queryFn:w,staleTime:3e4});function K(e){_(t=>[...t,e]),console.info("[session]",e)}function B(e){L(t=>[...t.filter(t=>t.type!==e.type),e])}function J(e){e?L(t=>t.filter(t=>t.type!==e)):L([])}function W(){B({type:"network",message:"Network connection lost. Retry connection or end to save.",actions:[{label:"Retry connection",onClick:Z},{label:"End and save",onClick:V}]})}async function Z(){if(K("Retrying connection"),!i||!P.current)return void K("Retry skipped: missing session or realtime client");g("connecting"),z("refreshing");try{await P.current.refresh(!0),J("network"),J("token"),K("Realtime connection refreshed"),g("listening"),z("valid")}catch(t){let e=t instanceof Error?t.message:"unknown retry error";k("Connection retry failed"),K("Retry failed: ".concat(e)),W(),z("error")}}async function Q(){if(k(null),T(!1),J(),!t){k("Select a topic"),K("Start aborted: no topic selected");return}if(M||!navigator.onLine){k("Network connection lost"),W();return}let e=await c();if(O(e),"granted"!==e){k("Microphone permission required"),K("Mic permission denied"),B({type:"mic",message:"Microphone permission required. Please allow access and retry.",actions:[{label:"Retry mic",onClick:Q}]});return}J("mic");let s=null;try{s=await navigator.mediaDevices.getUserMedia({audio:!0}),C(s);let e=await fetch("".concat(y,"/api/sessions"),{method:"POST",headers:{"Content-Type":"application/json","x-user-id":v},body:JSON.stringify({topic_id:t})});if(!e.ok)throw Error("Failed to create session");let n=await e.json();h(n),K("Session created: ".concat(n.id));let i=function(e,t,s){let n="idle",i=null;async function r(){let n=arguments.length>0&&void 0!==arguments[0]&&arguments[0],r=arguments.length>1?arguments[1]:void 0;return i=await l(e,t,s,{forceRefresh:n,status:r})}return{get status(){return n},async start(){n="connecting",(i=await r(!1,"active"))&&console.debug("Obtained client secret",i.client_secret),n="listening"},async stop(){n="ended"},async finalize(){n="ended"},async refresh(){let e=arguments.length>0&&void 0!==arguments[0]&&arguments[0];n="recovering";let t=await r(e,"recovering");return n="listening",t}}}(y,n.id,v);g("connecting"),z("refreshing"),P.current=i,await i.start(),J("token"),J("network"),z("valid");let r=new d;I.current=r,await r.start(s),T(!0),K("Realtime client started and recording began"),g("listening")}catch(t){null==s||s.getTracks().forEach(e=>e.stop()),C(null),I.current=null,P.current=null,h(null),g("error"),z("error");let e=t instanceof Error?t.message:"Unknown start error";k("Failed to start session"),K("Start failed: ".concat(e)),!navigator.onLine||M?W():B({type:"token",message:"Realtime token expired. Refresh to continue or end to save.",actions:[{label:"Retry connection",onClick:Z},{label:"End and save",onClick:V}]})}}async function V(){if(!i)return;k(null),g("ending"),z("refreshing"),J("mic");let e=I.current;if(!e){k("Recorder not started"),K("End failed: recorder missing");return}let t=await e.stop();T(!1),null==E||E.getTracks().forEach(e=>e.stop()),K("Recording stopped");let s=new FormData;s.append("file",t.blob,"audio.webm"),s.append("duration_seconds",Math.round(t.durationMs/1e3).toString());let n=await fetch("".concat(y,"/api/sessions/").concat(i.id,"/upload"),{method:"POST",headers:{"x-user-id":v},body:s}).catch(()=>k("Upload failed"));if(!n||!n.ok){k("Upload failed"),K("Upload failed"),g("error"),z("error"),W();return}let r=null;try{let e=await n.json();r=e.storage_url||e.audio_url||null,K("Audio uploaded: ".concat(null!=r?r:"no url"))}catch(e){K("Upload response parse failed")}r||K("Upload response missing audio URL; finalizing without audio reference");let a=await fetch("".concat(y,"/api/sessions/").concat(i.id,"/finalize"),{method:"POST",headers:{"Content-Type":"application/json","x-user-id":v},body:JSON.stringify({transcript:[],status:"ended",duration_seconds:Math.round(t.durationMs/1e3),...r?{audio_url:r}:{}})}).catch(()=>k("Finalize failed"));if(a&&a.ok){let e=await a.json();b((e.transcript||[]).map(e=>({speaker:e.speaker,text:e.text}))),g(e.status||"ended"),J(),z("valid"),K("Session finalized and transcript received (".concat((e.transcript||[]).length," segments)"))}else k("Finalize failed"),g("error"),z("error"),K("Finalize failed"),W()}(0,a.useEffect)(()=>{A&&(k(A.message),K("Failed to load topics"))},[A]),(0,a.useEffect)(()=>{H.length>0&&K("Topics loaded")},[H]),(0,a.useEffect)(()=>{let n=e.get("topicId");n&&H.length>0&&!t&&H.some(e=>e.id===n)&&(s(n),K("Preselected topic from link: ".concat(n)))},[e,H,t]),(0,a.useEffect)(()=>{function e(){D(!0),W()}function t(){D(!1),J("network")}return window.addEventListener("offline",e),window.addEventListener("online",t),()=>{window.removeEventListener("offline",e),window.removeEventListener("online",t)}},[i]);let Y=F.map(e=>({id:e.type,tone:"mic"===e.type?"mic":"token"===e.type?"token":"network",message:e.message,actions:e.actions})),G=H.find(e=>e.id===t),X=e.get("topicTitle")||void 0,$=(null==G?void 0:G.title)||X||"Select a topic";return(0,n.jsxs)("div",{className:"page page-session",children:[(0,n.jsxs)("div",{className:"page-header",children:[(0,n.jsxs)("div",{children:[(0,n.jsx)("p",{className:"eyebrow",children:"Session"}),(0,n.jsxs)("h2",{children:["Topic: ",$]})]}),(0,n.jsxs)("div",{className:"actions-inline",children:[(0,n.jsx)(j,{onClick:Q,disabled:"listening"===m||"connecting"===m,children:"Start Session"}),(0,n.jsx)(j,{variant:"secondary",onClick:V,disabled:!i||"ended"===m||!R,children:"End Session"})]})]}),(0,n.jsxs)("div",{className:"session-layout",children:[(0,n.jsxs)("section",{className:"session-main","aria-label":"session controls and recording",children:[(0,n.jsxs)("div",{className:"control-row",children:[(0,n.jsx)("label",{htmlFor:"topic",children:"Topic"}),(0,n.jsxs)("select",{id:"topic",value:t,onChange:e=>s(e.target.value),"aria-label":"topic picker",children:[(0,n.jsx)("option",{value:"",children:"Select…"}),H.map(e=>(0,n.jsxs)("option",{value:e.id,children:[e.title," ",e.difficulty?"(".concat(e.difficulty,")"):""]},e.id))]})]}),(0,n.jsx)(x,{status:{connection:"listening"===m?"active":"connecting"===m?"connecting":M?"recovering":"error"===m?"error":"idle",mic:q,token:U,info:"ending"===m?"Finalizing…":void 0}}),(0,n.jsxs)("div",{className:"meta-row","aria-live":"polite",children:[(0,n.jsxs)("span",{children:["Status: ",m]}),(0,n.jsxs)("span",{children:["Mic: ",q]})]}),N&&(0,n.jsx)("p",{role:"status",className:"text-danger m-0",children:N}),(0,n.jsx)("div",{className:"recording-panel","aria-label":"speech recording display",children:(0,n.jsx)("span",{children:"Speech recording display"})})]}),(0,n.jsxs)("aside",{className:"session-side","aria-label":"conversation and alerts",children:[(0,n.jsxs)("div",{className:"side-panel",children:[(0,n.jsx)("div",{className:"section-title",children:"Conversation log / transcript"}),(0,n.jsx)(u,{segments:f})]}),(0,n.jsxs)("div",{className:"side-panel",children:[(0,n.jsx)("div",{className:"section-title",children:"Alerts & Debug"}),(0,n.jsx)(p,{alerts:Y}),(0,n.jsx)("div",{className:"debug-log","aria-label":"debug-log",children:0===S.length?(0,n.jsx)("p",{style:{margin:0},children:"No events yet."}):(0,n.jsx)("ul",{style:{margin:0,paddingLeft:16},children:S.map((e,t)=>(0,n.jsx)("li",{children:e},t))})})]})]})]})]})}var _=s(5894);function E(e){var t;let{onSelect:s}=e,r=(0,i.Zp)(),a=(0,_.jE)(),{data:l=[],isLoading:c,isError:d,error:u}=(0,o.I)({queryKey:["sessions"],queryFn:N,staleTime:15e3,refetchOnWindowFocus:!1,retry:!1});async function h(e){if(window.confirm("Delete this session?")){if(!(await fetch("".concat(y,"/api/sessions/").concat(e),{method:"DELETE",headers:{"x-user-id":v}})).ok)return void console.error("Delete failed");a.setQueryData(["sessions"],t=>(null!=t?t:[]).filter(t=>t.id!==e))}}return(0,n.jsxs)("section",{className:"page page-history",children:[(0,n.jsxs)("div",{className:"page-header",children:[(0,n.jsxs)("div",{children:[(0,n.jsx)("p",{className:"eyebrow",children:"History"}),(0,n.jsx)("h2",{children:"History"})]}),(0,n.jsx)(j,{onClick:()=>r("/session"),children:"Start a session"})]}),c&&(0,n.jsx)("p",{children:"Loading…"}),d&&(0,n.jsx)("p",{className:"text-danger",children:null!=(t=null==u?void 0:u.message)?t:"History load failed"}),c||0!==l.length?(0,n.jsx)("div",{className:"history-list",role:"list",children:l.map(e=>{var t;return(0,n.jsxs)("article",{className:"history-row",role:"listitem",children:[(0,n.jsxs)("div",{className:"history-row__content",children:[(0,n.jsx)("h3",{children:e.topic_title}),(0,n.jsxs)("p",{className:"meta-row",children:[(0,n.jsx)("span",{children:new Date(e.start_time).toLocaleString()}),(0,n.jsxs)("span",{children:["Duration: ",null!=(t=e.duration_seconds)?t:"?","s"]}),(0,n.jsx)(m,{label:e.status,tone:"ended"===e.status?"active":"recovering"===e.status?"recovering":"error"===e.status?"error":"idle"})]})]}),(0,n.jsxs)("div",{className:"history-row__actions",children:[s?(0,n.jsx)(j,{variant:"secondary",onClick:()=>s(e.id),children:"Open"}):(0,n.jsx)(b,{to:"/sessions/".concat(e.id),variant:"secondary",children:"Open"}),(0,n.jsx)(j,{variant:"danger",onClick:()=>h(e.id),children:"Delete"})]})]},e.id)})}):(0,n.jsxs)("div",{className:"empty-state",role:"status",children:[(0,n.jsx)("div",{className:"empty-illustration","aria-hidden":"true"}),(0,n.jsxs)("div",{children:[(0,n.jsx)("h3",{children:"No sessions yet"}),(0,n.jsx)("p",{children:"Start a new session to see your progress here."}),(0,n.jsx)(j,{onClick:()=>r("/session"),children:"Start a session"})]})]})]})}function C(e){let{children:t,title:s,actions:i,className:r}=e;return(0,n.jsxs)("div",{className:"bg-surfaceAlt border border-border rounded-[12px] p-5 shadow-soft ".concat(null!=r?r:""),children:[(s||i)&&(0,n.jsxs)("header",{className:"flex items-center justify-between mb-3",children:[s&&(0,n.jsx)("h3",{className:"m-0 text-lg font-bold",children:s}),i&&(0,n.jsx)("div",{className:"flex gap-2",children:i})]}),t]})}function R(e){var t;let{sessionId:s,onBack:r}=e,a=(0,i.g)(),l=s||a.id||a.sessionId,{data:c,isLoading:d,isError:h,error:p}=(0,o.I)({queryKey:["session",l],queryFn:()=>k(String(l)),enabled:!!l,staleTime:3e4,refetchOnWindowFocus:!1,retry:!1});return(0,n.jsxs)("section",{className:"page session-detail",children:[(0,n.jsxs)("div",{className:"page-header",children:[(0,n.jsxs)("div",{children:[(0,n.jsx)("p",{className:"eyebrow",children:"History"}),(0,n.jsx)("h2",{children:"History Detail"}),(0,n.jsxs)("div",{className:"meta-row",children:[(0,n.jsx)("span",{children:c?new Date(c.start_time).toLocaleString():""}),(null==c?void 0:c.duration_seconds)?(0,n.jsxs)("span",{children:[c.duration_seconds,"s"]}):null,c?(0,n.jsx)(m,{label:c.status,tone:"ended"===c.status?"active":"recovering"===c.status?"recovering":"error"===c.status?"error":"idle"}):null]})]}),r&&(0,n.jsx)(j,{variant:"secondary",onClick:r,children:"Back to history"})]}),d&&(0,n.jsx)("p",{children:"Loading…"}),h&&(0,n.jsx)("p",{className:"text-danger",children:null!=(t=null==p?void 0:p.message)?t:"Failed to load session"}),c&&(0,n.jsxs)(C,{children:[(0,n.jsx)("h3",{style:{marginTop:0},children:c.topic_title}),c.audio_url?(0,n.jsx)("audio",{className:"audio-player","aria-label":"session audio player",src:c.audio_url,controls:!0}):(0,n.jsx)("p",{children:"No audio available for this session."}),(0,n.jsx)("h4",{children:"Transcript"}),(0,n.jsx)(u,{segments:c.transcript||[]})]})]})}function T(e){let{title:t,topics:s,onSelect:i}=e;return(0,n.jsxs)("section",{className:"topic-section",children:[(0,n.jsx)("h3",{children:t}),(0,n.jsx)("div",{className:"tile-grid",children:Array.from({length:3}).map((e,r)=>{var a,o;let l=s[r],c=!l;return(0,n.jsx)("button",{type:"button",className:"topic-tile",onClick:()=>l&&i(l),disabled:c,"aria-label":l?"Start session for ".concat(l.title):"Topic coming soon",children:(0,n.jsx)("span",{children:null!=(a=null==l?void 0:l.title)?a:"Coming soon"})},null!=(o=null==l?void 0:l.id)?o:"".concat(t,"-").concat(r))})})]})}function F(){var e;let t=(0,i.Zp)(),{data:s=[],isLoading:r,isError:l,error:c}=(0,o.I)({queryKey:["topics"],queryFn:w,staleTime:3e4}),d=(0,a.useMemo)(()=>s.slice(0,3),[s]),u=(0,a.useMemo)(()=>s.slice(3,6),[s]);function h(e){t("/session?topicId=".concat(encodeURIComponent(e.id),"&topicTitle=").concat(encodeURIComponent(e.title)))}return(0,n.jsxs)("div",{className:"page home-page",children:[(0,n.jsx)("p",{className:"eyebrow",children:"Home"}),(0,n.jsx)("h1",{children:"Practice your speech"}),(0,n.jsx)("p",{className:"lede",children:"Pick a topic to start a self-practice session or work with an agent. Your history will be saved automatically."}),l&&(0,n.jsx)("p",{className:"text-danger",children:null!=(e=null==c?void 0:c.message)?e:"Failed to load topics"}),r&&(0,n.jsx)("p",{children:"Loading topics…"}),(0,n.jsxs)("div",{className:"home-grid",children:[(0,n.jsx)(T,{title:"Solo",topics:d,onSelect:h}),(0,n.jsx)(T,{title:"Interactive",topics:u,onSelect:h})]})]})}function L(){let e=(0,i.zy)().pathname,t="/session"===e,s="/history"===e||e.startsWith("/sessions");return(0,n.jsxs)("header",{className:"app-header",children:[(0,n.jsx)("div",{className:"brand",children:"Speech Dojo"}),(0,n.jsxs)("nav",{className:"nav","aria-label":"Primary",children:[(0,n.jsx)(r.N_,{to:"/","aria-current":"/"===e?"page":void 0,children:"Home"}),(0,n.jsx)(r.N_,{to:"/session","aria-current":t?"page":void 0,children:"Session"}),(0,n.jsx)(r.N_,{to:"/history","aria-current":s?"page":void 0,children:"History"})]})]})}let M=function(){return(0,n.jsxs)(r.Kd,{children:[(0,n.jsx)("a",{href:"#main",className:"skip-link",children:"Skip to main content"}),(0,n.jsx)("div",{className:"app-header-wrapper",children:(0,n.jsx)(L,{})}),(0,n.jsx)("div",{className:"app-shell",children:(0,n.jsx)("main",{id:"main",role:"main",children:(0,n.jsxs)(i.BV,{children:[(0,n.jsx)(i.qh,{path:"/",element:(0,n.jsx)(F,{})}),(0,n.jsx)(i.qh,{path:"/session",element:(0,n.jsx)(S,{})}),(0,n.jsx)(i.qh,{path:"/history",element:(0,n.jsx)(E,{})}),(0,n.jsx)(i.qh,{path:"/sessions/:id",element:(0,n.jsx)(R,{})})]})})})]})}}}]);